import UIKit
import SwiftyJSON
import Foundation
import NaturalLanguage

let path = "/Users/zhengyitang/SwiftProjects/Exer/json_nlp.playground/Resources/CN_mayuri_main.json"
let url = URL(fileURLWithPath: path)
let data = try Data(contentsOf: url)
let json = try JSON(data: data)
print("读取数据完毕")

//一共几组问答
print("一共有", json["conversations"].count, "组问答: ")
//第一组问答
//print(json["conversations"][0])
//第一组的问题
//print(json["conversations"][0][0])
//第一组的答案
//print(json["conversations"][0][1])

var Question_match = [[String]]()
var Question_list: [String] = []
var Question_index : [Int] = []
let threshold = 0.4
//获得index array
for i in 0..<json["conversations"].count {
    print("第", i, "组问答里有: ", json["conversations"][i][0].count, "个问题")
    Question_index += Array(repeating: i, count: json["conversations"][i][0].count)
}
//print(Question_index)

//把index加入question match array
Question_match.append(Question_index.map(String.init)) //需要转变成string
print("写入index完毕")
//print(Question_match)

//读取JSON里的问题，并存入Question_list
for (_,QA) in json["conversations"] {
    for (index, text) in QA {
//        print("index: ", index)
//        print("text: ", text)
        if index == "0" {
//            print("text in if: ", text)
            for (_, ii) in text {
                Question_list.append(ii.stringValue)
            }
        }
    }
}
//print(Question_list)

Question_match.append(Question_list)
print("写入问题完毕")

if Question_list.count == Question_index.count {
    print("前期准备完毕")
} else {
    print("准备阶段有错误发生")
}
print(Question_match)
//比对相似度，并存入question score
var Question_score: [String] = []
if let sentenceEmbedding = NLEmbedding.sentenceEmbedding(for: .english) {
    let sentence = "你好"
//    if let vector = sentenceEmbedding.vector(for: sentence) {
//        print(vector)
//    }
    print("问题: ", sentence)
    for i in Question_list {
        let distance = sentenceEmbedding.distance(between: sentence, and: i)
        let score : String = distance.description
        Question_score.append(score)
//        print(i)
//        print(distance.description)
    }
}
print("fuzzy matching完毕")

Question_match.append(Question_score)
print(Question_match)

let min_score = Question_score.map{ Double ($0)!}.min()
print("min score: ", min_score!)

if min_score! < threshold {
    let find_score_index = Question_match[2].firstIndex(of: String(min_score!))

    let find_q_index = Question_match[0][find_score_index!]

    print("Best match question: ", Question_match[1][find_score_index!])

    print("Question index in corpus: ", find_q_index)

    //此问题的全部回答
    //print(json["conversations"][Int(find_q_index) ?? 0][1])

    //随机选出回答
    let (index, answers) = json["conversations"][Int(find_q_index) ?? 0][1].randomElement()!
//print("回答: ", index, answer)
    for (_, answer) in answers {
        print(answer)
    }
}
else {print("没有这条对话")}
